#!/usr/bin/env python3
import argparse
import os
import subprocess
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent


def run_script(script_rel_path, extra_args, use_python=False, env=None):
    """
    Run a script located under <repo_root>/scripts>.

    script_rel_path: e.g. "build.sh"
    extra_args: list of extra CLI args to forward
    use_python: whether to run via python3 script.py ...
    env: optional environment overrides (merged with os.environ)
    """
    scripts_dir = REPO_ROOT / "scripts"
    script_path = scripts_dir / script_rel_path
    if not script_path.exists():
        print(f"Error: script not found: {script_path}", file=sys.stderr)
        sys.exit(1)

    if use_python:
        cmd = ["python3", str(script_path), *extra_args]
    else:
        cmd = [str(script_path), *extra_args]

    if os.environ.get("KOLMOPLAS_DEBUG"):
        print("+", " ".join(cmd))

    env_final = os.environ.copy()
    if env:
        env_final.update(env)

    result = subprocess.call(cmd, env=env_final)
    sys.exit(result)


def run_regression_case(case_name: str, extra_args):
    """
    Run a single regression case as an 'example' by reusing
    scripts/run_regression_tests.sh and CTest's name regex filter.

    This assumes tests are named like:
      regression::fluids::<case_name>::run
    """
    regex = rf"^regression::fluids::{case_name}::run$"
    env = {"CTEST_NAME_REGEX": regex}
    run_script("run_regression_tests.sh", extra_args, env=env)


def register_script_leaf(subparsers, name, script, help_text, use_python=False):
    """
    Register a leaf subcommand that simply wraps a script in scripts/.

    - 'kolmoplas ... name -h/--help' is forwarded to the script.
    - Group-level 'kolmoplas test -h' etc. still shows argparse routing help.
    """
    p = subparsers.add_parser(
        name,
        add_help=False,      # so -h/--help is not intercepted here
        help=help_text,
        description=help_text,
    )

    def _runner(ns, extra, script=script, use_python=use_python):
        run_script(script, extra, use_python=use_python)

    p.set_defaults(func=_runner)
    return p


def main():
    parser = argparse.ArgumentParser(
        prog="kolmoplas",
        description="KolmoPlas devOps / workflow CLI (thin wrapper around scripts/).",
    )
    subparsers = parser.add_subparsers(dest="command", required=True)

    # --- build ---
    register_script_leaf(
        subparsers,
        name="build",
        script="build.sh",
        help_text="Configure & build the project (scripts/build.sh).",
    )

    # --- clean ---
    register_script_leaf(
        subparsers,
        name="clean",
        script="clean_build.sh",
        help_text="Clean CMake/Ninja build trees (scripts/clean_build.sh).",
    )

    # --- docs ---
    register_script_leaf(
        subparsers,
        name="docs",
        script="build_docs.sh",
        help_text="Build and optionally serve docs (scripts/build_docs.sh).",
    )

    # --- test ---
    p_test = subparsers.add_parser(
        "test",
        help="Run tests: unit, perf, or reg (wrappers around run_*.sh).",
    )
    test_subparsers = p_test.add_subparsers(dest="which", required=True)

    register_script_leaf(
        test_subparsers,
        name="unit",
        script="run_unit_tests.sh",
        help_text="Run unit tests (scripts/run_unit_tests.sh).",
    )
    register_script_leaf(
        test_subparsers,
        name="perf",
        script="run_perf_tests.sh",
        help_text="Run performance tests (scripts/run_perf_tests.sh).",
    )
    register_script_leaf(
        test_subparsers,
        name="reg",
        script="run_regression_tests.sh",
        help_text="Run regression test suite (scripts/run_regression_tests.sh).",
    )

    # --- scaling ---
    p_scaling = subparsers.add_parser(
        "scaling",
        help="Run or post-process scaling studies.",
    )
    scaling_subparsers = p_scaling.add_subparsers(dest="which", required=True)

    register_script_leaf(
        scaling_subparsers,
        name="run",
        script="run_scaling.sh",
        help_text="Run scaling experiments (scripts/run_scaling.sh).",
    )
    register_script_leaf(
        scaling_subparsers,
        name="post",
        script="postprocess_scaling.py",
        help_text="Post-process scaling CSVs (scripts/postprocess_scaling.py).",
        use_python=True,
    )

    # --- clean-extern ---
    register_script_leaf(
        subparsers,
        name="clean-extern",
        script="clean_extern.sh",
        help_text="Clean extern/ (scripts/clean_extern.sh).",
    )

    # --- fmt ---
    register_script_leaf(
        subparsers,
        name="fmt",
        script="format_all.sh",
        help_text="Format C/C++/Fortran/CMake (scripts/format_all.sh).",
    )

    # --- prefetch ---
    register_script_leaf(
        subparsers,
        name="prefetch",
        script="prefetch_third_party.sh",
        help_text="Prefetch third-party archives (scripts/prefetch_third_party.sh).",
    )

    # --- post (post-processing utilities) ---
    p_post = subparsers.add_parser(
        "post",
        help="Post-process simulation results (spectra, cavity, etc.).",
    )
    post_subparsers = p_post.add_subparsers(dest="which", required=True)

    register_script_leaf(
        post_subparsers,
        name="tgv-spectrum",
        script="tgv_spectrum.py",
        help_text="Compute isotropic TGV energy spectrum (scripts/tgv_spectrum.py).",
        use_python=True,
    )
    register_script_leaf(
        post_subparsers,
        name="ghia",
        script="ldc_ghia.py",
        help_text="Cavity regression vs Ghia et al. (scripts/ldc_ghia.py).",
        use_python=True,
    )

    # --- examples ---
    p_examples = subparsers.add_parser(
        "examples",
        help="Run real solver examples backed by regression cases.",
    )
    ex_subparsers = p_examples.add_subparsers(dest="which", required=True)

    p_ex_run = ex_subparsers.add_parser(
        "run",
        help=(
            "Run a named example case (e.g. tgv128, channel128) "
            "by filtering regression tests."
        ),
    )
    p_ex_run.add_argument(
        "case",
        help="Example/regression case name (e.g. tgv128)",
    )

    def _examples_run(ns, extra):
        run_regression_case(ns.case, extra)

    p_ex_run.set_defaults(func=_examples_run)

    # --- parse + dispatch (IMPORTANT: parse_known_args) ---
    ns, extra = parser.parse_known_args()
    # extra = arguments not consumed by argparse (e.g. --help, script flags)
    ns.func(ns, extra)


if __name__ == "__main__":
    main()
